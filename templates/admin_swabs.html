{% extends "base.html" %}
{% block content %}
  <div class="grid grid-2">
    <div class="card">
      <h1>Nuovo tampone</h1>
      <form method="post" autocomplete="off">
        <input type="hidden" name="action" value="add" />
        <label class="muted small">SKU</label>
        <input name="sku" placeholder="es. TB-0001" required />
        <label class="muted small" style="margin-top:8px;">Nome tampone</label>
        <input name="name" placeholder="es. Tampone A" required />
        <div style="margin-top:12px;">
          <button type="submit">Aggiungi tampone</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h1>Lista tamponi (Admin)</h1>

      <form method="get" style="margin-top:10px;" autocomplete="off">
        <label class="muted small" for="swab-search-admin">Cerca</label>
        <input id="swab-search-admin" name="q" placeholder="Cerca per Nome o Macchina" value="{{ q }}" />
      </form>

      <form id="print-selected-form" method="get" action="{{ url_for('labels_print') }}" target="_blank" rel="noopener" autocomplete="off" style="margin-top:12px;">
        <button type="submit">Stampa selezionati</button>
      </form>

      <div class="table-wrap" style="margin-top:12px;">
        <table class="rtable">
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="select-all-skus" aria-label="Seleziona tutti i tamponi" />
              </th>
              <th>Tampone</th>
              <th>SKU</th>
              <th>Stato</th>
              <th>Macchina</th>
              <th>Ultimo PRESO</th>
              <th>Ultimo RESO</th>
              <th>Giorni uso</th>
              <th>Barcode</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr class="{% if r['alarm'] %}row-alarm{% elif r['warning'] %}row-warn{% endif %}">
                <td data-label="Seleziona">
                  <input type="checkbox" name="selected_skus" value="{{ r['sku'] }}" form="print-selected-form" aria-label="Seleziona {{ r['sku'] }}" />
                </td>
                <td data-label="Tampone"><strong>{{ r["name"] }}</strong></td>
                <td data-label="SKU" class="mono muted">{{ r["sku"] }}</td>

                <td data-label="Stato">
                  {% if r["in_stock"] == 1 %}
                    <span class="pill ok">RESO</span>
                  {% else %}
                    <span class="pill warn">PRESO</span>
                  {% endif %}
                {% if r["alarm"] %}
                  <span class="pill err">Allarme: oltre {{ global_alarm_days }} gg superati</span>
                {% elif r["warning"] %}
                  <span class="pill warn">Avviso: oltre {{ global_warn_days }} gg in scadenza</span>
                {% endif %}
                </td>

                <td data-label="Macchina">
                  {% if r["in_stock"] == 0 and r["machine_name"] %}
                    <span class="pill warn">{{ r["machine_name"] }}</span>
                  {% else %}
                    <span class="muted small">Magazzino</span>
                  {% endif %}
                </td>

                <td data-label="Ultimo PRESO" class="mono">
                  {% if r["last_take_ts"] %}{{ r["last_take_ts"] | it_datetime }}{% else %}<span class="muted small">‚Äî</span>{% endif %}
                </td>

                <td data-label="Ultimo RESO" class="mono">
                  {% if r["last_return_ts"] %}{{ r["last_return_ts"] | it_datetime }}{% else %}<span class="muted small">‚Äî</span>{% endif %}
                </td>

                <td data-label="Giorni uso">
                  <span class="pill ok">Tot: {{ r["total_days"] }}</span>
                  {% if r["in_stock"] == 0 and r["open_taken_ts"] %}
                    <span class="pill warn">Ora: {{ r["current_days"] }}</span>
                  {% endif %}
                </td>

                <td data-label="Barcode">
                  <div class="pill-row">
                    <a href="{{ url_for('label_png', sku=r['sku']) }}" target="_blank" rel="noopener">
                      <span class="pill ok">Apri PNG</span>
                    </a>
                    <a href="{{ url_for('label_print', sku=r['sku']) }}" target="_blank" rel="noopener">
                      <span class="pill ok">üñ®Ô∏è Stampa</span>
                    </a>
                  </div>
                </td>

                <td data-label="Azioni">
                  <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                    <form method="get" action="{{ url_for('swab_edit', swab_id=r['id']) }}" style="margin:0;" autocomplete="off">
                      <button type="submit">Modifica</button>
                    </form>

                    <form method="post" action="{{ url_for('swab_delete', swab_id=r['id']) }}" style="margin:0;" autocomplete="off"
                          onsubmit="return confirm('Eliminare definitivamente questo tampone?');">
                      <button type="submit">Elimina</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}

            {% if rows|length == 0 %}
              <tr><td colspan="10" class="muted">Nessun tampone.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="muted small" style="margin-top:10px;">
        Nota: non puoi eliminare un tampone se risulta <strong>PRESO</strong> (rendilo prima).
      </div>
    </div>
  </div>
  <script>
    const selectAll = document.getElementById("select-all-skus");
    const skuCheckboxes = document.querySelectorAll('input[name="selected_skus"]');

    if (selectAll) {
      selectAll.addEventListener("change", () => {
        skuCheckboxes.forEach((checkbox) => {
          checkbox.checked = selectAll.checked;
        });
      });
    }

    skuCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", () => {
        const allChecked = Array.from(skuCheckboxes).every((item) => item.checked);
        const anyChecked = Array.from(skuCheckboxes).some((item) => item.checked);
        if (selectAll) {
          selectAll.indeterminate = !allChecked && anyChecked;
          selectAll.checked = allChecked;
        }
      });
    });
  </script>
{% endblock %}
