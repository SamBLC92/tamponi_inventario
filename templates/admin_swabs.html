{% extends "base.html" %}
{% block content %}
  <div class="row g-3">
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h1 class="h4 mb-3">Nuovo tampone</h1>
          <form method="post">
            <input type="hidden" name="action" value="add" />
            <label class="form-label text-secondary small">SKU</label>
            <input name="sku" class="form-control" placeholder="es. TB-0001" required />
            <label class="form-label text-secondary small mt-3">Nome tampone</label>
            <input name="name" class="form-control" placeholder="es. Tampone A" required />
            <div class="mt-3">
              <button type="submit" class="btn btn-primary w-100">Aggiungi tampone</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card h-100">
        <div class="card-body">
          <h1 class="h4 mb-3">Lista tamponi (Admin)</h1>

          <form method="get" class="mb-3">
            <label class="form-label text-secondary small" for="swab-search-admin">Cerca</label>
            <input id="swab-search-admin" class="form-control swab-search" name="q" placeholder="Cerca per Nome o Macchina" value="{{ q }}" />
          </form>

          <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Tampone</th>
                  <th>SKU</th>
                  <th>Stato</th>
                  <th>Macchina</th>
                  <th>Ultimo PRESO</th>
                  <th>Ultimo RESO</th>
                  <th>Giorni uso</th>
                  <th>Barcode</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody>
                {% for r in rows %}
                <tr class="{% if r['alarm'] %}row-alarm{% elif r['warning'] %}row-warn{% endif %}">
                    <td data-label="Tampone"><strong>{{ r["name"] }}</strong></td>
                    <td data-label="SKU" class="font-monospace text-secondary">{{ r["sku"] }}</td>

                    <td data-label="Stato">
                      {% if r["in_stock"] == 1 %}
                        <span class="badge bg-success">RESO</span>
                      {% else %}
                        <span class="badge bg-warning text-dark">PRESO</span>
                      {% endif %}
                    {% if r["alarm"] %}
                      <span class="badge bg-danger">Allarme: oltre {{ global_alarm_days }} gg superati</span>
                    {% elif r["warning"] %}
                      <span class="badge bg-warning text-dark">Avviso: oltre {{ global_warn_days }} gg in scadenza</span>
                    {% endif %}
                    </td>

                    <td data-label="Macchina">
                      {% if r["in_stock"] == 0 and r["machine_name"] %}
                        <span class="badge bg-warning text-dark">{{ r["machine_name"] }}</span>
                      {% else %}
                        <span class="text-secondary small">Magazzino</span>
                      {% endif %}
                    </td>

                    <td data-label="Ultimo PRESO" class="font-monospace">
                      {% if r["last_take_ts"] %}{{ r["last_take_ts"] | it_datetime }}{% else %}<span class="text-secondary small">—</span>{% endif %}
                    </td>

                    <td data-label="Ultimo RESO" class="font-monospace">
                      {% if r["last_return_ts"] %}{{ r["last_return_ts"] | it_datetime }}{% else %}<span class="text-secondary small">—</span>{% endif %}
                    </td>

                    <td data-label="Giorni uso">
                      <span class="badge bg-success">Tot: {{ r["total_days"] }}</span>
                      {% if r["in_stock"] == 0 and r["open_taken_ts"] %}
                        <span class="badge bg-warning text-dark">Ora: {{ r["current_days"] }}</span>
                      {% endif %}
                    </td>

                    <td data-label="Barcode">
                      <a class="btn btn-sm btn-outline-success" href="{{ url_for('label_png', sku=r['sku']) }}" target="_blank">
                        Apri PNG
                      </a>
                    </td>

                    <td data-label="Azioni">
                      <div class="d-flex gap-2 flex-wrap justify-content-end">
                        <form method="get" action="{{ url_for('swab_edit', swab_id=r['id']) }}" class="m-0">
                          <button type="submit" class="btn btn-sm btn-outline-primary">Modifica</button>
                        </form>

                        <form method="post" action="{{ url_for('swab_delete', swab_id=r['id']) }}" class="m-0"
                              onsubmit="return confirm('Eliminare definitivamente questo tampone?');">
                          <button type="submit" class="btn btn-sm btn-outline-danger">Elimina</button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}

                {% if rows|length == 0 %}
                  <tr><td colspan="9" class="text-secondary">Nessun tampone.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <div class="text-secondary small mt-3">
            Nota: non puoi eliminare un tampone se risulta <strong>PRESO</strong> (rendilo prima).
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
