{% extends "base.html" %}
{% block content %}
  <div class="grid grid-2">
    <div class="card">
      <h1>Nuovo tampone</h1>
      <form method="post" autocomplete="off">
        <input type="hidden" name="action" value="add" />
        <label class="muted small">SKU</label>
        <input name="sku" placeholder="es. TB-0001" required />
        <label class="muted small" style="margin-top:8px;">Nome tampone</label>
        <input name="name" placeholder="es. Tampone A" required />
        <div style="margin-top:12px;">
          <button type="submit">Aggiungi tampone</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h1>Lista tamponi</h1>

      <form method="get" style="margin-top:10px;" autocomplete="off">
        <input id="swab-search-admin" name="q" placeholder="Cerca per Nome o Macchina" value="{{ q }}" />
      </form>

      <form id="print-selected-form" method="get" action="{{ url_for('labels_print') }}" target="_blank" rel="noopener" autocomplete="off" style="display: flex;margin-top:12px;justify-content: space-between;border: 1px solid var(--line);border-radius: 12px;padding: 5px;align-items: center;">
        <label style="margin-left: 12px;">Selezionati</label>
        <button class="nav-gear" type="submit" style="width: auto;padding: 8px;">
          <svg viewBox="0 0 52 52">
            <path d="M46.5,17.4h-41c-2.2,0-4,1.8-4,4v14c0,2.2,1.8,4,4,4h5.9l0,5.8c0,2.2,1.8,4,4,4h21.3c2.2,0,4-1.8,4-4l0-5.8
            h5.9c2.2,0,4-1.8,4-4v-14C50.5,19.2,48.7,17.4,46.5,17.4z M8.3,27.7c-1.7,0-3-1.3-3-3c0-1.7,1.3-3,3-3s3,1.3,3,3
            C11.3,26.4,10,27.7,8.3,27.7z M35.9,43.1c0,0.8-0.7,1.5-1.5,1.5h-17c-0.8,0-1.5-0.7-1.5-1.5v-9.8c0-0.8,0.7-1.5,1.5-1.5h17
            c0.8,0,1.5,0.7,1.5,1.5V43.1z">
            </path>
            <path d="M40.5,11.1c0,0.8-0.7,1.5-1.5,1.5H12.8c-0.8,0-1.5-0.7-1.5-1.5V4.3c0-0.8,0.7-1.5,1.5-1.5H39
            c0.8,0,1.5,0.7,1.5,1.5V11.1z">
            </path>
          </svg>
        </button>
      </form>

      <div class="table-wrap" style="margin-top:12px;">
        <table class="rtable">
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="select-all-skus" aria-label="Seleziona tutti i tamponi" />
              </th>
              <th>Tampone</th>
              <th>SKU</th>
              <th>Stato</th>
              <th>Macchina</th>
              <th>Ultimo PRESO</th>
              <th>Ultimo RESO</th>
              <th>Giorni uso</th>
              <th>Barcode</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr class="{% if r['alarm'] %}row-alarm{% elif r['warning'] %}row-warn{% endif %}">
                <td data-label="Seleziona">
                  <input type="checkbox" name="selected_skus" value="{{ r['sku'] }}" form="print-selected-form" aria-label="Seleziona {{ r['sku'] }}" />
                </td>
                <td data-label="Tampone"><strong>{{ r["name"] }}</strong></td>
                <td data-label="SKU" class="mono muted">{{ r["sku"] }}</td>

                <td data-label="Stato">
                  {% if r["in_stock"] == 1 %}
                    <span class="pill ok">RESO</span>
                  {% else %}
                    <span class="pill warn">PRESO</span>
                  {% endif %}
                {% if r["alarm"] %}
                  <span class="pill err">Allarme: oltre {{ global_alarm_days }} gg superati</span>
                {% elif r["warning"] %}
                  <span class="pill warn">Avviso: oltre {{ global_warn_days }} gg in scadenza</span>
                {% endif %}
                </td>

                <td data-label="Macchina">
                  {% if r["in_stock"] == 0 and r["machine_name"] %}
                    <span class="pill warn">{{ r["machine_name"] }}</span>
                  {% else %}
                    <span class="muted small">Magazzino</span>
                  {% endif %}
                </td>

                <td data-label="Ultimo PRESO" class="mono">
                  {% if r["last_take_ts"] %}{{ r["last_take_ts"] | it_datetime }}{% else %}<span class="muted small">—</span>{% endif %}
                </td>

                <td data-label="Ultimo RESO" class="mono">
                  {% if r["last_return_ts"] %}{{ r["last_return_ts"] | it_datetime }}{% else %}<span class="muted small">—</span>{% endif %}
                </td>

                <td data-label="Giorni uso">
                  <span class="pill ok">Tot: {{ r["total_days"] }}</span>
                  {% if r["in_stock"] == 0 and r["open_taken_ts"] %}
                    <span class="pill warn">Ora: {{ r["current_days"] }}</span>
                  {% endif %}
                </td>

                <td data-label="Barcode">
                  <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content: flex-start;">
                    <form method="get" action="{{ url_for('label_png', sku=r['sku']) }}" style="margin:0;" autocomplete="off">
                      <button class="nav-gear" type="submit" formtarget="_blank" style="padding: 8px;">
                        <svg viewBox="0 0 24 24">
                          <path d="M20,3H4A3,3,0,0,0,1,6V18a3,3,0,0,0,3,3H20a3,3,0,0,0,3-3V6A3,3,0,0,0,20,3Zm1,15a1,1,0,0,1-1,1H4a1,1,0,0,1-1-1V6A1,1,0,0,1,4,5H20a1,1,0,0,1,1,1ZM7,8v8a1,1,0,0,1-2,0V8A1,1,0,0,1,7,8Zm3,0v4a1,1,0,0,1-2,0V8a1,1,0,0,1,2,0Zm3,0v8a1,1,0,0,1-2,0V8a1,1,0,0,1,2,0Zm3,0v4a1,1,0,0,1-2,0V8a1,1,0,0,1,2,0Zm3,0v8a1,1,0,0,1-2,0V8a1,1,0,0,1,2,0Zm-9,7v1a1,1,0,0,1-2,0V15a1,1,0,0,1,2,0Zm6,0v1a1,1,0,0,1-2,0V15a1,1,0,0,1,2,0Z">
                          </path>
                        </svg>
                      </button>
                    </form>
                    <form method="get" action="{{ url_for('label_print', sku=r['sku']) }}" style="margin:0;" autocomplete="off">
                      <button class="nav-gear" type="submit" formtarget="_blank" style="padding: 8px;">
                        <svg viewBox="0 0 52 52">
                          <path d="M46.5,17.4h-41c-2.2,0-4,1.8-4,4v14c0,2.2,1.8,4,4,4h5.9l0,5.8c0,2.2,1.8,4,4,4h21.3c2.2,0,4-1.8,4-4l0-5.8
                            h5.9c2.2,0,4-1.8,4-4v-14C50.5,19.2,48.7,17.4,46.5,17.4z M8.3,27.7c-1.7,0-3-1.3-3-3c0-1.7,1.3-3,3-3s3,1.3,3,3
                            C11.3,26.4,10,27.7,8.3,27.7z M35.9,43.1c0,0.8-0.7,1.5-1.5,1.5h-17c-0.8,0-1.5-0.7-1.5-1.5v-9.8c0-0.8,0.7-1.5,1.5-1.5h17
                            c0.8,0,1.5,0.7,1.5,1.5V43.1z">
                          </path>
                          <path d="M40.5,11.1c0,0.8-0.7,1.5-1.5,1.5H12.8c-0.8,0-1.5-0.7-1.5-1.5V4.3c0-0.8,0.7-1.5,1.5-1.5H39
                            c0.8,0,1.5,0.7,1.5,1.5V11.1z">
                          </path>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>

                <td data-label="Azioni">
                  <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start;">
                    <form method="get" action="{{ url_for('swab_edit', swab_id=r['id']) }}" style="margin:0;" autocomplete="off">
                      <button class="nav-gear" type="submit" style="padding: 8px;">
                        <svg viewBox="0 0 24 24">
                          <path d="M20.9888 4.28491L19.6405 2.93089C18.4045 1.6897 16.4944 1.6897 15.2584 2.93089L13.0112 5.30042L18.7416 11.055L21.1011 8.68547C21.6629 8.1213 22 7.33145 22 6.54161C22 5.75176 21.5506 4.84908 20.9888 4.28491Z"></path>
                          <path d="M16.2697 10.9422L11.7753 6.42877L2.89888 15.3427C2.33708 15.9069 2 16.6968 2 17.5994V21.0973C2 21.5487 2.33708 22 2.89888 22H6.49438C7.2809 22 8.06742 21.6615 8.74157 21.0973L17.618 12.1834L16.2697 10.9422Z"></path>
                        </svg>
                      </button>
                    </form>

                    <form method="post" action="{{ url_for('swab_delete', swab_id=r['id']) }}" style="margin:0;" autocomplete="off"
                          onsubmit="return confirm('Eliminare definitivamente questo tampone?');">
                      <button class="nav-gear" type="submit" style="padding: 8px;">
                        <svg viewBox="0 0 52 52">
                          <g>
                            <path d="M45.5,10H33V6c0-2.2-1.8-4-4-4h-6c-2.2,0-4,1.8-4,4v4H6.5C5.7,10,5,10.7,5,11.5v3C5,15.3,5.7,16,6.5,16h39
                              c0.8,0,1.5-0.7,1.5-1.5v-3C47,10.7,46.3,10,45.5,10z M23,7c0-0.6,0.4-1,1-1h4c0.6,0,1,0.4,1,1v3h-6V7z"></path>
                            <path d="M41.5,20h-31C9.7,20,9,20.7,9,21.5V45c0,2.8,2.2,5,5,5h24c2.8,0,5-2.2,5-5V21.5C43,20.7,42.3,20,41.5,20z
                               M23,42c0,0.6-0.4,1-1,1h-2c-0.6,0-1-0.4-1-1V28c0-0.6,0.4-1,1-1h2c0.6,0,1,0.4,1,1V42z M33,42c0,0.6-0.4,1-1,1h-2
                              c-0.6,0-1-0.4-1-1V28c0-0.6,0.4-1,1-1h2c0.6,0,1,0.4,1,1V42z"></path>
                          </g>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}

            {% if rows|length == 0 %}
              <tr><td colspan="10" class="muted">Nessun tampone.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="muted small" style="margin-top:10px;">
        Nota: non puoi eliminare un tampone se risulta <strong>PRESO</strong> (rendilo prima).
      </div>
    </div>
  </div>
  <script>
    const selectAll = document.getElementById("select-all-skus");
    const skuCheckboxes = document.querySelectorAll('input[name="selected_skus"]');

    if (selectAll) {
      selectAll.addEventListener("change", () => {
        skuCheckboxes.forEach((checkbox) => {
          checkbox.checked = selectAll.checked;
        });
      });
    }

    skuCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", () => {
        const allChecked = Array.from(skuCheckboxes).every((item) => item.checked);
        const anyChecked = Array.from(skuCheckboxes).some((item) => item.checked);
        if (selectAll) {
          selectAll.indeterminate = !allChecked && anyChecked;
          selectAll.checked = allChecked;
        }
      });
    });
  </script>
{% endblock %}
