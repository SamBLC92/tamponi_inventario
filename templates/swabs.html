{% extends "base.html" %}
{% block content %}
  <div class="card">
    <div class="card-body">
      <h1 class="h4 mb-3">Lista tamponi</h1>

      <form method="get" class="mb-3">
        <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
          <label class="form-label text-secondary small mb-0" for="swab-search">Cerca</label>
          <input id="swab-search" class="form-control swab-search" name="q" placeholder="Cerca per Nome o Macchina" value="{{ q }}" />
        </div>
      </form>

      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Tampone</th>
              <th>SKU</th>
              <th>Stato</th>
              <th>Macchina</th>
              <th>Ultimo PRESO</th>
              <th>Ultimo RESO</th>
              <th>Giorni uso</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr class="{% if r['alarm'] %}table-danger{% elif r['warning'] %}table-warning{% endif %}">
                <td data-label="Tampone"><strong>{{ r["name"] }}</strong></td>
                <td data-label="SKU" class="font-monospace text-secondary">{{ r["sku"] }}</td>

                <td data-label="Stato">
                  {% if r["in_stock"] == 1 %}
                    <span class="badge bg-success">RESO</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">PRESO</span>
                  {% endif %}
                  {% if r["alarm"] %}
                    <span class="badge bg-danger">Allarme: oltre {{ global_alarm_days }} gg superati</span>
                  {% elif r["warning"] %}
                    <span class="badge bg-warning text-dark">Avviso: oltre {{ global_warn_days }} gg in scadenza</span>
                  {% endif %}
                </td>

                <td data-label="Macchina">
                  {% if r["in_stock"] == 0 and r["machine_name"] %}
                    <span class="badge bg-warning text-dark">{{ r["machine_name"] }}</span>
                  {% else %}
                    <span class="text-secondary small">Magazzino</span>
                  {% endif %}
                </td>

                <td data-label="Ultimo PRESO" class="font-monospace">
                  {% if r["last_take_ts"] %}{{ r["last_take_ts"] | it_datetime }}{% else %}<span class="text-secondary small">—</span>{% endif %}
                </td>

                <td data-label="Ultimo RESO" class="font-monospace">
                  {% if r["last_return_ts"] %}{{ r["last_return_ts"] | it_datetime }}{% else %}<span class="text-secondary small">—</span>{% endif %}
                </td>

                <td data-label="Giorni uso">
                  <span class="badge bg-success">Tot: {{ r["total_days"] }}</span>
                  {% if r["in_stock"] == 0 and r["open_taken_ts"] %}
                    <span class="badge bg-warning text-dark">Ora: {{ r["current_days"] }}</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}

            {% if rows|length == 0 %}
              <tr><td colspan="7" class="text-secondary">Nessun tampone.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="text-secondary small mt-3">
        Nota: non puoi eliminare un tampone se risulta <strong>PRESO</strong> (rendilo prima).
      </div>
    </div>
  </div>
{% endblock %}
