{% extends "base.html" %}
{% block content %}
  <div class="row g-3">
    <div class="col-12 col-lg-5">
      <div class="card h-100">
        <div class="card-body">
          <h1 class="h4 mb-2">Scansione con fotocamera</h1>
          <p class="text-secondary">
            Soglie globali:
            <span class="badge bg-warning text-dark">Avviso {{ global_warn_days }} gg in scadenza</span>
            <span class="badge bg-danger ms-2">Allarme {{ global_alarm_days }} gg superati</span>
          </p>

          <div class="row g-3 mt-1">
            <div class="col-12 col-md-6">
              <label class="form-label text-secondary small">Modalità</label>
              <select id="mode" class="form-control">
                <option value="TOGGLE" selected>TOGGLE (preso/reso)</option>
                <option value="TAKE">PRESO (forza)</option>
                <option value="RETURN">RESO (forza)</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label text-secondary small">Cooldown letture</label>
              <select id="cooldown" class="form-control">
                <option value="1200" selected>1.2s</option>
                <option value="2000">2s</option>
                <option value="3000">3s</option>
              </select>
            </div>
          </div>

          <div class="border rounded-3 overflow-hidden mt-3">
            <div id="reader" class="w-100"></div>
          </div>

          <div id="result" class="mt-3"></div>
          <div class="text-secondary small mt-2">
            La fotocamera spesso richiede HTTPS (specialmente su iPhone).
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="card h-100">
        <div class="card-body">
          <h1 class="h4 mb-2">Ultimo esito</h1>
          <div id="last" class="text-secondary">Nessuna scansione ancora.</div>

          <div id="machineBox" class="border rounded-3 p-3 mt-3 d-none">
            <div class="d-flex justify-content-between gap-3 align-items-center">
              <strong>Seleziona macchina</strong>
              <span class="text-secondary small" id="machineSku"></span>
            </div>

            <div class="mt-3">
              <select id="machineSelect" class="form-control"></select>
            </div>

            <div class="mt-3 d-flex flex-column gap-2">
              <button id="machineConfirm" class="btn btn-success">Conferma PRESO</button>
              <button id="machineCancel" class="btn btn-outline-light">Annulla</button>
            </div>

            <div class="text-secondary small mt-2">
              Se la lista è vuota, vai su <strong>Macchine</strong> e aggiungile.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const resEl = document.getElementById("result");
    const lastEl = document.getElementById("last");
    const modeEl = document.getElementById("mode");
    const cooldownEl = document.getElementById("cooldown");

    const machineBox = document.getElementById("machineBox");
    const machineSelect = document.getElementById("machineSelect");
    const machineConfirm = document.getElementById("machineConfirm");
    const machineCancel = document.getElementById("machineCancel");
    const machineSku = document.getElementById("machineSku");

    let lastTs = 0;
    let pending = null;

    function pill(ok, text){
      const cls = ok ? "badge bg-success" : "badge bg-danger";
      return `<span class="${cls}">${text}</span>`;
    }

    function shouldAccept(){
      const cd = parseInt(cooldownEl.value, 10);
      const now = Date.now();
      if(now - lastTs < cd) return false;
      lastTs = now;
      return true;
    }

    function showMachinePicker(sku, machines){
      pending = { sku, mode: modeEl.value };
      machineSku.textContent = sku;

      machineSelect.innerHTML = "";
      for(const m of machines){
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.name;
        machineSelect.appendChild(opt);
      }
      machineBox.classList.remove("d-none");
    }

    function hideMachinePicker(){
      pending = null;
      machineBox.classList.add("d-none");
    }

    async function callScan(payload){
      const r = await fetch("/api/scan", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      return { r, j };
    }

    function renderOk(j){
      const stato = j.in_stock ? "RESO" : "PRESO";
      const az = (j.action === "TAKE") ? "PRESO" : "RESO";

      const warn = j.alarm
        ? ` <span class="badge bg-danger">Allarme: oltre ${j.alarm_days} gg superati</span>`
        : (j.warning ? ` <span class="badge bg-warning text-dark">Avviso: oltre ${j.warn_days} gg in scadenza</span>` : "");
      const infoDays = j.in_stock
        ? (j.days_session ? ` <span class="badge bg-success">Sessione: ${j.days_session} gg</span>` : "")
        : ` <span class="badge bg-warning text-dark">Fuori da: ${j.current_days} gg</span>`;

      const machineInfo = (!j.in_stock && j.machine_name)
        ? ` <span class="badge bg-warning text-dark">Macchina: ${j.machine_name}</span>`
        : ` <span class="text-secondary small"> Magazzino</span>`;

      const html = `
        <div>
          <span class="badge ${az==='PRESO' ? 'bg-warning text-dark' : 'bg-success'}">${az}</span>
          <strong class="font-monospace ms-2">${j.sku}</strong>
          <span class="text-secondary">— ${j.name} — ${stato} — ${j.ts}</span>
          ${machineInfo}
          ${infoDays}
          ${warn}
        </div>
      `;
      resEl.innerHTML = html;
      lastEl.innerHTML = html;
    }

    async function handleDecoded(sku){
      hideMachinePicker();
      resEl.innerHTML = `<div class="text-secondary">Invio ${sku}...</div>`;

      try{
        const { r, j } = await callScan({ sku, mode: modeEl.value });

        if(r.status === 409 && j.need_machine){
          resEl.innerHTML = `<div>${pill(false,"SERVE MACCHINA")} <span class="text-secondary">${j.message}</span></div>`;
          showMachinePicker(sku, j.machines || []);
          return;
        }

        if(!r.ok){
          const html = `<div>${pill(false, "ERRORE")} <span class="text-secondary">${j.error || "Errore"}</span></div>`;
          resEl.innerHTML = html;
          lastEl.innerHTML = html;
        } else {
          renderOk(j);
        }
      } catch(e){
        const html = `<div>${pill(false,"ERRORE")} <span class="text-secondary">${e}</span></div>`;
        resEl.innerHTML = html;
        lastEl.innerHTML = html;
      }
    }

    machineConfirm.addEventListener("click", async () => {
      if(!pending) return;
      const machine_id = parseInt(machineSelect.value, 10);
      if(!machine_id){
        resEl.innerHTML = `<div>${pill(false,"ERRORE")} <span class="text-secondary">Seleziona una macchina.</span></div>`;
        return;
      }

      resEl.innerHTML = `<div class="text-secondary">Registro PRESO con macchina...</div>`;
      try{
        const { r, j } = await callScan({ sku: pending.sku, mode: pending.mode, machine_id });

        if(!r.ok){
          const html = `<div>${pill(false, "ERRORE")} <span class="text-secondary">${j.error || "Errore"}</span></div>`;
          resEl.innerHTML = html;
          lastEl.innerHTML = html;
        } else {
          renderOk(j);
          hideMachinePicker();
        }
      } catch(e){
        resEl.innerHTML = `<div>${pill(false,"ERRORE")} <span class="text-secondary">${e}</span></div>`;
      }
    });

    machineCancel.addEventListener("click", () => hideMachinePicker());

    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 320, height: 140 }, rememberLastUsedCamera: true };

    const onSuccess = (decodedText) => {
      const sku = (decodedText || "").trim();
      if(!sku) return;
      if(!shouldAccept()) return;
      handleDecoded(sku);
    };
    const onError = (_err) => {};

    html5QrCode.start(
      { facingMode: "environment" },
      config,
      onSuccess,
      onError
    ).catch(() => {
      Html5Qrcode.getCameras().then(cameras => {
        if(!cameras || cameras.length === 0){
          resEl.innerHTML = `<div>${pill(false,"ERRORE")} <span class="text-secondary">Nessuna fotocamera trovata.</span></div>`;
          return;
        }
        const backCam = cameras.find(c => /back|rear|environment/i.test(c.label));
        const camId = (backCam || cameras[0]).id;

        html5QrCode.start(
          camId,
          config,
          onSuccess,
          onError
        ).catch(e => {
          resEl.innerHTML = `<div>${pill(false,"ERRORE")} <span class="text-secondary">Impossibile avviare la camera: ${e}</span></div>`;
        });
      }).catch(e => {
        resEl.innerHTML = `<div>${pill(false,"ERRORE")} <span class="text-secondary">Errore camere: ${e}</span></div>`;
      });
    });
  </script>
{% endblock %}
